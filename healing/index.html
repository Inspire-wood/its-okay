<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>힐링메세지 메이커 — Inspire Wood</title>
<meta name="theme-color" content="#111111">
<style>
  :root{
    --maxw: 900px; --radius: 16px; --shadow: 0 12px 36px rgba(0,0,0,.08);
    --muted:#666;
  }
  *{ box-sizing: border-box }
  html,body{ margin:0; padding:0; }
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
    background:
      radial-gradient(1100px 700px at 10% -10%, rgba(255,232,210,.85), transparent 60%),
      radial-gradient(900px 600px at 95% 110%, rgba(255,214,214,.7), transparent 55%),
      linear-gradient(180deg, #fff7f0 0%, #fde7d8 100%);
    color:#111; line-height:1.55;
  }
  .wrap{ padding: clamp(16px, 4vw, 40px); display:flex; justify-content:center }
  .container{ width:100%; max-width: var(--maxw); display:grid; gap: 16px }
  header{ display:flex; align-items:baseline; gap: 12px; flex-wrap:wrap }
  h1{ margin:0; font-size: clamp(22px, 3.6vw, 32px) }
  .sub{ color: var(--muted); font-size: 13px }

  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
         border:1px solid #e5e7eb; background:#fff; text-decoration:none; color:#111; font-weight:600; font-size:13px; }
  .chip:hover{ border-color:#d1d5db }

  .grid{ display:grid; gap:16px }
  .card{ background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: clamp(16px, 2.8vw, 28px); }
  label{ font-size: 14px; font-weight:600; display:block; margin-bottom: 6px }
  input[type="text"], input[type="url"], input[readonly], textarea, select{
    width:100%; padding:12px 12px; border-radius: 12px; border:1px solid #ddd; font-size:16px;
  }
  input[readonly]{ background:#fafafa; color:#555 }
  textarea{ resize: vertical; min-height: 84px }
  .rows{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
  .btn{ padding:10px 14px; border-radius: 12px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:14px }
  .btn.primary{ background:#111; color:#fff; border-color:#111 }
  .btn.ghost{ background:#f7f7f7 }
  .small{ font-size:12px; color:#777 }
  .out{ background:#fff; border-radius: 12px; border:1px dashed #ddd; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all; }
  .divider{ height:1px; background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,0)); margin: 12px 0 }
  .list{ display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:4px }
  .item{ display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; }
  .item input[type="text"]{ padding:10px 10px; font-size:14px }
  .muted{ color:#6b7280; font-size:12px }
  .danger{ color:#b91c1c }
</style>
</head>
<body>
  <div class="wrap">
    <div class="container">

      <div class="topbar">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <a class="chip" href="../">← Healing (Landing)</a>
          <a class="chip" href="../tools/">Tools Dashboard</a>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="chip" id="exportData">Export JSON</button>
          <label class="chip" style="cursor:pointer">Import JSON<input type="file" id="importData" accept="application/json" style="display:none"></label>
          <button class="chip" id="resetAll">Reset</button>
        </div>
      </div>

      <header>
        <h1>힐링메세지 메이커</h1>
        <div class="sub">주문자 이름 · 카테고리 · 문장 목록을 관리하고 URL/단축TXT를 만듭니다.</div>
      </header>

      <section class="card grid">
        <div class="rows">
          <div>
            <label for="name">주문자 이름</label>
            <input type="text" id="name" placeholder="예: 김민지 / Olivia / Team IW">
          </div>
          <div>
            <label for="base">Base URL (Healing 랜딩)</label>
            <div class="row">
              <input type="url" id="base" value="https://inspire-wood.github.io/its-okay/healing/">
              <button class="btn" id="detectBase">현재 경로</button>
            </div>
            <div class="small">보통 수정할 필요 없음</div>
          </div>
        </div>

        <div class="rows">
          <div>
            <label for="cat">메세지 항목 선택</label>
            <div class="row">
              <select id="cat" aria-label="카테고리 선택"></select>
              <button class="btn" id="addCat">항목 추가</button>
            </div>
            <div class="small">기본: 힐링메세지 · 성경구절 · 기타</div>
          </div>
          <div>
            <label for="newCat" id="newCatLabel" style="display:none">새 항목 이름</label>
            <div class="row" id="newCatRow" style="display:none">
              <input type="text" id="newCat" placeholder="예: 감사문장 / 축복문장">
              <button class="btn primary" id="saveCat">저장</button>
            </div>
          </div>
        </div>

        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <h3 style="margin:0">선택한 항목의 메세지 목록</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="addMsg">문장 추가</button>
              <button class="btn ghost" id="saveList">저장</button>
              <span class="small">라디오 선택된 문장이 URL 생성에 사용됩니다.</span>
            </div>
          </div>
          <div class="list" id="msgList" aria-label="메세지 목록"></div>
          <p class="muted">예시 — 힐링메세지: 오늘의 햇살처럼 마음도 밝아지길 · 성경구절: 주는 그리스도 시요 살아계신 하나님의 아들이시니이다. (마16:16)</p>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div>
            <h3 style="margin:0 0 8px">URL 생성 / 복사 / 새창</h3>
            <div class="rows">
              <div>
                <label for="preview">선택된 문장 미리보기</label>
                <textarea id="preview" readonly placeholder="문장을 선택하세요"></textarea>
              </div>
              <div>
                <label>동작</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn primary" id="build">URL 생성</button>
                  <button class="btn" id="copy">URL 복사</button>
                  <a class="btn" id="open" target="_blank" rel="noopener">새 창에서 열기</a>
                </div>
                <div style="height:10px"></div>
                <div class="out" id="out">여기에 결과 URL이 표시됩니다</div>
              </div>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 8px">단축 URL · TXT 다운로드</h3>
            <div class="rows">
              <div>
                <label for="slug">슬러그(slug)</label>
                <div class="row">
                  <input type="text" id="slug" placeholder="예: mj-healing / grace-001">
                  <button class="btn" id="autoslug">자동 생성</button>
                </div>
                <div class="small" id="shortInfo">단축 형태는 <code>https://inspire-wood.github.io/its-okay/go/[slug].html</code> 입니다.</div>
              </div>
              <div>
                <label>다운로드</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <a class="btn" id="downloadTxt" download="order.txt">[주문자이름].txt</a>
                  <a class="btn ghost" id="downloadRedirect" download="slug.html">리디렉트 파일(옵션)</a>
                </div>
                <div class="small">요청사항: 단축 URL을 텍스트 파일로 저장합니다. (리디렉트 HTML은 선택)</div>
              </div>
            </div>
          </div>
        </div>

      </section>

      <p class="muted">© Inspire Wood — Healing Message Maker v1</p>
    </div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const key = 'healingMakerV1';

  // ----- State helpers -----
  function load(){
    try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch(e){ return {}; }
  }
  function save(st){ localStorage.setItem(key, JSON.stringify(st)); }

  function defaultState(){
    return {
      name: '', base: 'https://inspire-wood.github.io/its-okay/healing/',
      cats: ['힐링메세지','성경구절','기타'],
      msgs: {
        '힐링메세지': ['오늘의 햇살처럼 마음도 밝아지길'],
        '성경구절': ['주는 그리스도 시요 살아계신 하나님의 아들이시니이다. 마16:16'],
        '기타': []
      },
      currentCat: '힐링메세지',
      selected: { '힐링메세지': 0 },
      slug: ''
    };
  }

  let st = Object.assign(defaultState(), load());
  init();

  // ----- UI init -----
  function init(){
    // inputs
    $('#name').value = st.name || '';
    $('#base').value = st.base || defaultState().base;
    $('#slug').value = st.slug || '';

    // cats
    renderCats();
    $('#cat').value = st.currentCat;
    renderList();

    // wire up
    $('#name').addEventListener('input', ()=>{ st.name = $('#name').value; save(st); syncDownloads(); });
    $('#base').addEventListener('input', ()=>{ st.base = $('#base').value; save(st); });
    $('#cat').addEventListener('change', ()=>{ st.currentCat = $('#cat').value; save(st); renderList(); });
    $('#addCat').addEventListener('click', showAddCat);
    $('#saveCat').addEventListener('click', addCategory);

    $('#addMsg').addEventListener('click', ()=> addMsg(''));
    $('#saveList').addEventListener('click', saveList);

    $('#build').addEventListener('click', buildUrl);
    $('#copy').addEventListener('click', async ()=>{
      const url = buildUrl();
      try{ await navigator.clipboard.writeText(url); alert('복사됨'); }catch(e){ prompt('복사 실패 — 수동으로 복사하세요', url); }
    });
    $('#open').addEventListener('click', buildUrl);

    $('#autoslug').addEventListener('click', ()=>{ $('#slug').value = slugifyCandidate(); st.slug = $('#slug').value; save(st); syncDownloads(); });
    $('#slug').addEventListener('input', ()=>{ st.slug = $('#slug').value; save(st); syncDownloads(); });

    $('#detectBase').addEventListener('click', ()=>{
      try{
        const {origin, pathname} = location;
        const ix = pathname.indexOf('/its-okay/');
        const base = ix>=0 ? (origin + pathname.slice(0, ix+10) + 'healing/') : 'https://inspire-wood.github.io/its-okay/healing/';
        $('#base').value = base; st.base = base; save(st);
      }catch(e){}
    });

    $('#exportData').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(st,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='healing-maker-data.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });
    $('#importData').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        st = Object.assign(defaultState(), obj); save(st);
        init(); alert('가져오기 완료');
      }catch(e){ alert('JSON 파싱 실패: '+e.message); }
    });
    $('#resetAll').addEventListener('click', ()=>{
      if(!confirm('모든 값을 초기화할까요?')) return;
      localStorage.removeItem(key); st = defaultState(); init();
    });

    // initial
    syncDownloads();
    buildUrl();
  }

  // ----- Category -----
  function renderCats(){
    const el = $('#cat'); el.innerHTML = '';
    st.cats.forEach(c=>{
      const o = document.createElement('option'); o.value = c; o.textContent = c; el.appendChild(o);
    });
  }
  function showAddCat(){
    $('#newCatLabel').style.display='block';
    $('#newCatRow').style.display='grid';
    $('#newCat').focus();
  }
  function addCategory(){
    const name = ($('#newCat').value||'').trim();
    if(!name) return alert('이름을 입력하세요');
    if(st.cats.includes(name)) return alert('이미 존재합니다');
    st.cats.push(name); st.msgs[name] = []; st.selected[name] = 0; st.currentCat = name; save(st);
    $('#newCat').value = ''; $('#newCatLabel').style.display='none'; $('#newCatRow').style.display='none';
    renderCats(); $('#cat').value = name; renderList();
  }

  // ----- Messages -----
  function renderList(){
    const wrap = $('#msgList'); wrap.innerHTML = '';
    const cat = st.currentCat;
    const list = st.msgs[cat] || [];
    list.forEach((txt, idx)=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <input type="radio" name="pick" ${(st.selected[cat]||0)===idx?'checked':''} aria-label="선택">
        <input type="text" value="${escapeHtml(txt)}" aria-label="문장">
        <button class="btn" title="삭제">삭제</button>
      `;
      const r = row.querySelector('input[type="radio"]');
      const t = row.querySelector('input[type="text"]');
      const d = row.querySelector('button');
      r.addEventListener('change', ()=>{ st.selected[cat] = idx; save(st); updatePreview(); });
      t.addEventListener('input', ()=>{ list[idx] = t.value; save(st); updatePreview(); });
      d.addEventListener('click', ()=>{
        if(confirm('삭제할까요?')){ list.splice(idx,1); if((st.selected[cat]||0)>=list.length) st.selected[cat]=0; save(st); renderList(); }
      });
      wrap.appendChild(row);
    });
    updatePreview();
  }
  function addMsg(txt){
    const cat = st.currentCat;
    st.msgs[cat] = st.msgs[cat]||[]; st.msgs[cat].push(txt||''); st.selected[cat] = st.msgs[cat].length-1;
    save(st); renderList();
  }
  function saveList(){ save(st); alert('저장됨'); }

  function currentMessage(){
    const cat = st.currentCat;
    const list = st.msgs[cat]||[];
    const ix = Math.max(0, Math.min(st.selected[cat]||0, list.length-1));
    return list[ix]||'';
  }
  function updatePreview(){ $('#preview').value = currentMessage(); }

  // ----- URL Build -----
  function buildUrl(){
    const base = ($('#base').value||'').trim() || 'https://inspire-wood.github.io/its-okay/healing/';
    const name = ($('#name').value||'').trim();
    const cat = st.currentCat;
    const msg = currentMessage();

    const params = new URLSearchParams();
    if(name) params.set('name', name);
    if(cat) params.set('cat', cat);
    if(msg) params.set('msg', msg);
    const url = base.replace(/\/+$/,'/') + (params.toString()?('?'+params.toString()):'');
    $('#out').textContent = url;
    $('#open').href = url;
    syncDownloads();
    return url;
  }

  // ----- Short & Downloads -----
  function slugifyCandidate(){
    const name = ($('#name').value||'').trim().toLowerCase();
    let s = name.replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    if(!s){
      const n = name||st.currentCat||'h';
      s = 'h-'+ (n.charCodeAt(0)||104).toString(36);
    }
    return s;
  }
  function syncDownloads(){
    const slug = ($('#slug').value||'').trim() || slugifyCandidate();
    const longUrl = buildUrl();
    const shortUrl = 'https://inspire-wood.github.io/its-okay/go/' + slug + '.html';
    $('#shortInfo').innerHTML = '단축 링크: <code>'+shortUrl+'</code> (파일 업로드 필요: <code>go/'+slug+'.html</code>)';

    // TXT
    const name = ($('#name').value||'주문자').trim();
    const txt = 'Healing Link\\n\\nLong: '+longUrl+'\\nShort: '+shortUrl+'\\n\\nName: '+name+'\\nCategory: '+(st.currentCat||'')+'\\n';
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const urlTxt = URL.createObjectURL(blob);
    const aTxt = $('#downloadTxt'); aTxt.href = urlTxt; aTxt.download = (name||'order') + '.txt';

    // Redirect HTML (optional)
    const html = '<!doctype html><meta charset="utf-8">'+
                 '<meta http-equiv="refresh" content="0;url='+longUrl.replace(/\"/g,'&quot;')+'">'+
                 '<link rel="canonical" href="'+longUrl.replace(/\"/g,'&quot;')+'">'+
                 '<title>Redirecting...</title>'+
                 '<p>Redirecting to <a href="'+longUrl.replace(/\"/g,'&quot;')+'">target</a>...</p>';
    const blob2 = new Blob([html], {type:'text/html'});
    const url2 = URL.createObjectURL(blob2);
    const a2 = $('#downloadRedirect'); a2.href = url2; a2.download = slug + '.html';
  }

  // HTML escape for inputs
  function escapeHtml(str){ return (str||'').replace(/[&<>"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s])); }
</script>
</body>
</html>
