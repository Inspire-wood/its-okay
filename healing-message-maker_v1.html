<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healing Message Maker (v1) â€” based on Linkâ€‘Maker v2â€‘2 layout</title>

  <!-- Google Fonts: free for commercial use -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Gowun+Dodum&family=Nanum+Myeongjo:wght@400;700;800&family=Do+Hyeon&family=IBM+Plex+Sans+KR:wght@300;400;500;700&family=Black+Han+Sans&family=Jua&display=swap" rel="stylesheet">

  <!-- QRCode.js (lightweight) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <!-- html-to-image for PNG export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js" defer></script>

  <style>
    :root{
      --bg: #0e0d0c;
      --panel: #1a1816;
      --muted: #a19a92;
      --brand: #ffb86c;
      --accent: #ffd1a6;
      --ok: #29c46e;
      --warn: #ff9a3c;
      --danger: #ff5c5c;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --gradient-warm: radial-gradient(1200px 600px at 10% -20%, #ffe0b2 0%, transparent 60%),
                       radial-gradient(900px 500px at 100% 10%, #ffd7d7 0%, transparent 60%),
                       linear-gradient(135deg,#3b2a20 0%, #1d1612 55%, #120f0d 100%);
      --gradient-cool: radial-gradient(1200px 600px at 0% -20%, #c9ecff 0%, transparent 60%),
                       radial-gradient(900px 500px at 100% 10%, #d4d7ff 0%, transparent 60%),
                       linear-gradient(135deg,#1d2433 0%, #121823 55%, #0b0f16 100%);
      --gradient-wood: linear-gradient(180deg, #7a5a3a 0%, #6b5136 40%, #5a442e 100%);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      background:#0b0b0b;
      color:#eee;
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif;
    }
    .wrap{
      max-width:1200px;
      margin:24px auto;
      padding:0 16px 96px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:16px;
    }
    .title{
      font-size:20px; font-weight:800; letter-spacing:0.2px;
      display:flex; align-items:center; gap:10px;
    }
    .badge{font-size:12px; background:#322a22; padding:6px 10px; border-radius: 999px; color:#ffd1a6; border:1px solid #4d3e32;}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .panel{
      background: #171512;
      border:1px solid #2a241e;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .controls{ padding:16px; }
    .controls h3{ margin:12px 0 8px; font-size:14px; color:#ffcf99; letter-spacing:0.3px; }
    .row{ display:flex; gap:8px; }
    .row > *{ flex:1; }
    label{ font-size:12px; color:#bba; display:block; margin-bottom:6px; }
    input[type="text"], input[type="url"], textarea, select, input[type="number"], input[type="range"]{
      width:100%; background:#12100e; border:1px solid #2a241e; color:#eee; border-radius:10px;
      padding:10px 12px; outline:none;
    }
    textarea{ min-height:96px; resize:vertical; line-height:1.5; }
    .hint{ font-size:11px; color:#968b80; margin-top:6px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background:#2a241e; color:#ffd1a6; border:1px solid #3a3128; border-radius:12px; padding:10px 12px; cursor:pointer;
      user-select:none; text-decoration:none;
    }
    .btn.primary{ background: linear-gradient(180deg, #ffb86c, #ff9a3c); color:#1f140a; border-color:#ffa652; }
    .btn.ghost{ background: transparent; border-color:#3a3128; color:#d9c1aa; }
    .btn.full{ width:100%; }
    .btn.big{ padding:14px 16px; font-size:16px; font-weight:700; }
    .btn-group{ display:flex; flex-wrap:wrap; gap:8px; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .footer-note{ margin-top:14px; font-size:12px; color:#a99; }

    /* PREVIEW */
    .preview{
      padding:16px;
    }
    .card{
      position:relative;
      border-radius: 24px;
      overflow:hidden;
      min-height: 520px;
      background: var(--gradient-warm);
      border:1px solid #3b2e22;
      box-shadow: var(--shadow);
      display:grid;
      grid-template-rows: auto 1fr auto;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 20px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-size:12px; color:#f4e4d1; letter-spacing:0.4px;
    }
    .card-actions{ display:flex; gap:8px; }
    .play-big{
      position:absolute; right:16px; bottom:16px;
      display:inline-flex; align-items:center; gap:10px;
      background: rgba(255, 214, 170, 0.95);
      color:#2a1c12; border:1px solid #f1c495;
      padding:14px 16px; border-radius: 16px; font-weight:900; font-size:18px;
      cursor:pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .msg-wrap{
      padding:36px 28px 20px; display:flex; flex-direction:column; gap:12px;
    }
    .msg-main{
      font-size:42px; line-height:1.15; letter-spacing:0.2px; word-break:keep-all;
    }
    .msg-sub{
      font-size:16px; opacity:0.85;
    }
    .msg-to{
      font-size:14px; opacity:0.8;
    }
    .qr-wrap{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      background: rgba(32,24,18,0.45);
      border-top:1px solid rgba(255,255,255,0.08);
      padding:14px 16px;
    }
    .qr-box{
      background:#fff; padding:16px; border-radius:12px; line-height:0;
      border:1px solid #e8e8e8;
    }
    .qr-meta{ font-size:12px; color:#e9dccb; }
    .font-credit{
      font-size:11px; color:#e9dccb; opacity:0.9; padding:8px 16px 16px;
    }
    .pill{ display:inline-block; font-size:11px; padding:4px 8px; border:1px dashed rgba(255,255,255,0.25); border-radius:999px; color:#ffe0b2; }
    .mini{ font-size:11px; opacity:0.7; }
    .sep{ height:1px; background:#2a241e; margin:10px 0; border:0; }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:11px; background:#251f1a; padding:2px 6px; border-radius:6px; border:1px solid #3a3128; color:#ffd1a6;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ğŸªµ Healing Message Maker <span class="badge">v1 Â· Linkâ€‘Maker v2â€‘2 ë ˆì´ì•„ì›ƒ ê¸°ë°˜</span></div>
      <div class="btn-group">
        <button class="btn ghost" id="btnHelp">ë„ì›€ë§</button>
        <button class="btn" id="btnReset">ì´ˆê¸°í™”</button>
        <button class="btn primary" id="btnSavePreset">í˜„ì¬ê°’ ì €ì¥</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: CONTROLS -->
      <section class="panel controls">
        <h3>â‘  íë§ ë©”ì„¸ì§€</h3>
        <label for="msgMain">ë©”ì„¸ì§€(í•œê¸€)</label>
        <textarea id="msgMain" placeholder="ì˜ˆ) ê´œì°®ì•„. ì˜¤ëŠ˜ì˜ ë„ˆë„ ì¶©ë¶„íˆ ë©‹ì ¸."></textarea>
        <div class="split">
          <div>
            <label for="msgSub">ë¡œë§ˆì/ì˜ë¬¸ (ìë™ ìƒì„± í›„ ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="msgSub" placeholder="e.g., It's okay. You're doing enough today.">
            <div class="btn-group" style="margin-top:6px">
              <button class="btn" id="btnRomanize">ê°„ì´ ë¡œë§ˆì ìë™</button>
              <button class="btn" id="btnRandom">ëœë¤</button>
              <button class="btn" id="btnToday">ì˜¤ëŠ˜ì˜ ë¬¸ì¥</button>
            </div>
          </div>
          <div>
            <label for="toName">ìˆ˜ì‹ ì(ì˜µì…˜)</label>
            <input type="text" id="toName" placeholder="ì˜ˆ) To. Kim.M.J">
            <div class="hint">ì¹´ë“œ í•˜ë‹¨ì— <span class="kbd">To. â€¦</span> í‘œê¸°</div>
          </div>
        </div>

        <h3>â‘¡ ë§í¬ & QR</h3>
        <label for="baseUrl">íƒ€ê²Ÿ URL (ëœë”©í˜ì´ì§€)</label>
        <input type="url" id="baseUrl" placeholder="ì˜ˆ) https://inspire-wood.github.io/its-okay/healing/index.html">
        <div class="row" style="margin-top:8px">
          <div>
            <label for="utm_source">UTM Source</label>
            <input type="text" id="utm_source" placeholder="qr">
          </div>
          <div>
            <label for="utm_medium">UTM Medium</label>
            <input type="text" id="utm_medium" placeholder="woodsign">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="utm_campaign">UTM Campaign</label>
            <input type="text" id="utm_campaign" placeholder="healing">
          </div>
          <div>
            <label for="quietZone">QR ì—¬ë°±(Quiet Zone, px)</label>
            <input type="number" id="quietZone" value="16" min="0" max="64">
          </div>
        </div>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn" id="btnBuildLink">ë§í¬ ìƒì„±</button>
          <a class="btn ghost" id="aPreviewLink" href="#" target="_blank" rel="noopener">ë§í¬ ì—´ê¸°</a>
          <button class="btn" id="btnCopyLink">ë§í¬ ë³µì‚¬</button>
          <button class="btn" id="btnMakeQR">QR ìƒì„±/ì—…ë°ì´íŠ¸</button>
        </div>
        <div class="hint">íŒ: ë§í¬ì— <span class="kbd">m</span>(ë©”ì„¸ì§€), <span class="kbd">r</span>(ë¡œë§ˆì), <span class="kbd">to</span>(ìˆ˜ì‹ ì) ì¿¼ë¦¬ë¥¼ ìë™ ì¶”ê°€í•©ë‹ˆë‹¤.</div>

        <h3>â‘¢ í°íŠ¸/ìŠ¤íƒ€ì¼</h3>
        <div class="row">
          <div>
            <label for="fontFamily">í°íŠ¸ ì„ íƒ</label>
            <select id="fontFamily">
              <option value="'Noto Sans KR', sans-serif">Noto Sans KR</option>
              <option value="'IBM Plex Sans KR', sans-serif">IBM Plex Sans KR</option>
              <option value="'Gowun Dodum', sans-serif">Gowun Dodum</option>
              <option value="'Nanum Myeongjo', serif">Nanum Myeongjo</option>
              <option value="'Do Hyeon', sans-serif">Do Hyeon</option>
              <option value="'Jua', sans-serif">Jua</option>
              <option value="'Black Han Sans', sans-serif">Black Han Sans</option>
            </select>
          </div>
          <div>
            <label for="fontWeight">ê¸€ì ë‘ê»˜ (<span id="wVal">700</span>)</label>
            <input type="range" id="fontWeight" min="300" max="900" step="100" value="700">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="tracking">ìê°„ (letter-spacing)</label>
            <input type="range" id="tracking" min="-1" max="2" step="0.1" value="0">
          </div>
          <div>
            <label for="leading">ì¤„ê°„ (line-height)</label>
            <input type="range" id="leading" min="1" max="1.8" step="0.05" value="1.15">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="theme">ë°°ê²½ í…Œë§ˆ</label>
            <select id="theme">
              <option value="warm">ë”°ëœ»í•œ ê·¸ë¼ë°ì´ì…˜</option>
              <option value="cool">ì‹œì›í•œ ê·¸ë¼ë°ì´ì…˜</option>
              <option value="wood">ìš°ë“œ í…ìŠ¤ì²˜</option>
            </select>
          </div>
          <div>
            <label for="showRoman">ë¡œë§ˆì í‘œì‹œ</label>
            <select id="showRoman">
              <option value="on">í‘œì‹œ</option>
              <option value="off">ìˆ¨ê¹€</option>
            </select>
          </div>
        </div>

        <h3>â‘£ ìŒì„± (TTS)</h3>
        <div class="row">
          <div>
            <label for="voice">ìŒì„±</label>
            <select id="voice"></select>
          </div>
          <div>
            <label for="rate">ì†ë„ (<span id="rateVal">1.00</span>)</label>
            <input type="range" id="rate" min="0.7" max="1.3" step="0.05" value="1.0">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="pitch">í”¼ì¹˜ (<span id="pitchVal">1.00</span>)</label>
            <input type="range" id="pitch" min="0.7" max="1.3" step="0.05" value="1.0">
          </div>
          <div class="btn-group" style="align-items:end">
            <button class="btn full" id="btnPreviewTTS">ë¯¸ë¦¬ë“£ê¸°</button>
          </div>
        </div>

        <h3>â‘¤ ë‚´ë³´ë‚´ê¸°</h3>
        <div class="btn-group">
          <button class="btn big primary" id="btnDownloadPNG">PNG ì €ì¥</button>
          <button class="btn big" id="btnCopyAll">ì „ì²´ ë³µì‚¬(JSON)</button>
        </div>

        <hr class="sep">
        <label for="fontCredit">í°íŠ¸ ì¶œì²˜(Font Credit)</label>
        <input type="text" id="fontCredit" placeholder="ì˜ˆ) ë³¸ë¬¸: Noto Sans KR (Google Fonts), ì œëª©: Black Han Sans (Google Fonts)">
        <div class="footer-note">ì…ë ¥ê°’ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•˜ë‹¤ ì—´ì–´ë„ ìœ ì§€ë¼ìš”.</div>
      </section>

      <!-- RIGHT: PREVIEW -->
      <section class="panel preview">
        <div class="card" id="card">
          <div class="card-header">
            <div class="brand">
              <span>ğŸŒ¿ Healing Sign</span>
              <span class="pill">Made in Korea</span>
            </div>
            <div class="card-actions">
              <button class="btn ghost" id="btnOpenLink">ì—´ê¸°</button>
              <button class="btn" id="btnCopyLinkTop">ë§í¬ ë³µì‚¬</button>
            </div>
          </div>

          <div class="msg-wrap" id="msgWrap">
            <div class="msg-main" id="viewMain">ê´œì°®ì•„. ì˜¤ëŠ˜ì˜ ë„ˆë„ ì¶©ë¶„íˆ ë©‹ì ¸.</div>
            <div class="msg-sub" id="viewSub">It's okay. You're doing enough today.</div>
            <div class="msg-to" id="viewTo">To. Someone</div>
          </div>

          <div class="qr-wrap">
            <div>
              <div class="qr-meta">
                <div>ëœë”©: <span class="mini" id="viewUrl">â€”</span></div>
                <div>QR: ì •ì‚¬ê°í˜• â€¢ ê³ ëŒ€ë¹„ â€¢ ì—¬ë°± í¬í•¨</div>
              </div>
            </div>
            <div class="qr-box" id="qrBox">
              <div id="qr" style="width:160px; height:160px;"></div>
            </div>
          </div>

          <button class="play-big" id="btnPlay">
            â–¶ï¸ í”Œë ˆì´ (ë“£ê¸°)
          </button>

          <div class="font-credit" id="viewFontCredit">Font: Noto Sans KR (Google Fonts)</div>
        </div>
      </section>
    </div>
  </div>

  <script>
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const els = {
    main: $("#msgMain"),
    sub: $("#msgSub"),
    to: $("#toName"),
    base: $("#baseUrl"),
    utm_source: $("#utm_source"),
    utm_medium: $("#utm_medium"),
    utm_campaign: $("#utm_campaign"),
    quietZone: $("#quietZone"),
    romanBtn: $("#btnRomanize"),
    randomBtn: $("#btnRandom"),
    todayBtn: $("#btnToday"),
    buildLink: $("#btnBuildLink"),
    copyLink: $("#btnCopyLink"),
    copyLinkTop: $("#btnCopyLinkTop"),
    aPreview: $("#aPreviewLink"),
    makeQR: $("#btnMakeQR"),
    fontFamily: $("#fontFamily"),
    fontWeight: $("#fontWeight"),
    tracking: $("#tracking"),
    leading: $("#leading"),
    showRoman: $("#showRoman"),
    theme: $("#theme"),
    voice: $("#voice"),
    rate: $("#rate"),
    pitch: $("#pitch"),
    previewTTS: $("#btnPreviewTTS"),
    downloadPNG: $("#btnDownloadPNG"),
    copyAll: $("#btnCopyAll"),
    openLink: $("#btnOpenLink"),
    fontCredit: $("#fontCredit"),
    reset: $("#btnReset"),
    help: $("#btnHelp"),
    savePreset: $("#btnSavePreset"),
    // views
    vMain: $("#viewMain"),
    vSub: $("#viewSub"),
    vTo: $("#viewTo"),
    vUrl: $("#viewUrl"),
    vCredit: $("#viewFontCredit"),
    card: $("#card"),
    msgWrap: $("#msgWrap"),
    qrBox: $("#qrBox"),
    qr: $("#qr"),
    play: $("#btnPlay"),
    wVal: $("#wVal"),
    rateVal: $("#rateVal"),
    pitchVal: $("#pitchVal"),
  };

  const STORAGE_KEY = "healingMakerV1";

  const MESSAGES = [
    ["ê´œì°®ì•„. ì˜¤ëŠ˜ì˜ ë„ˆë„ ì¶©ë¶„íˆ ë©‹ì ¸.", "It's okay. You're doing enough today."],
    ["ì²œì²œíˆ ê°€ë„ ë¼. ì¤‘ìš”í•œ ê±´ ë©ˆì¶”ì§€ ì•ŠëŠ” ê±°ì•¼.", "Go slow if you need. Just don't stop."],
    ["ë„ˆì˜ ì†ë„ë¡œ, ë„ˆì˜ ê¸¸ì„.", "Your pace. Your path."],
    ["ì‘ì€ í•œ ê±¸ìŒì´ í° ë³€í™”ë¥¼ ë§Œë“ ë‹¤.", "Small steps make big changes."],
    ["ì˜¤ëŠ˜ë„ ì˜ í•´ëƒˆì–´.", "You did well today."],
    ["ì ì‹œ ì‰¬ì–´ë„ ë¼. ì‰¼ë„ ìš©ê¸°ì•¼.", "It's okay to rest. Rest takes courage."],
    ["ë„ˆëŠ” ì‚¬ë‘ë°›ê¸° ì¶©ë¶„í•œ ì‚¬ëŒ.", "You are worthy of love."],
    ["ë¹›ì€ êµ¬ë¦„ ë’¤ì—ì„œë„ ìë€ë‹¤.", "Light grows even behind clouds."],
    ["ë§ˆìŒì´ ë§í•˜ëŠ” ê±¸ ë“¤ì–´ì¤˜.", "Listen to what your heart says."],
    ["ì‹œì‘ì´ ì‘ì•„ë„ ê´œì°®ì•„.", "It's okay to start small."],
    ["ê¾¸ì¤€í•¨ì€ ê²°êµ­ ë„ˆë¥¼ ë°ë ¤ë‹¤ ì¤€ë‹¤.", "Consistency will take you there."],
    ["ì‹¤ìˆ˜ëŠ” ì„±ì¥ì˜ ì¦ê±°ì•¼.", "Mistakes are signs of growth."],
    ["ë„ˆëŠ” ì´ë¯¸ ì¶©ë¶„íˆ ì†Œì¤‘í•´.", "You are already enough."],
    ["ì˜¤ëŠ˜ì˜ í•´ëŠ” ë„ˆë¥¼ ìœ„í•´ì„œë„ ë–´ì–´.", "The sun rose for you too."],
    ["í•˜ë£¨ì— í•˜ë‚˜, ë‚˜ë¥¼ ìœ„í•œ ì¹œì ˆ.", "One kindness a day, for me."],
    ["ë¶ˆì•ˆì€ ì§€ë‚˜ê°€ê³ , ë‚˜ëŠ” ë‚¨ì•„.", "Anxiety passes; I remain."],
    ["ì‘ì€ ê¸°ì¨ì„ í¬ê²Œ ëŠê»´ë´.", "Feel small joys in a big way."],
    ["ìˆ¨ í•œ ë²ˆ, ë§ˆìŒ í•œ ë²ˆ.", "One breath, one heart."],
    ["ê´œì°®ì•„ì§ˆ ê±°ì•¼. ì•„ë‹ˆ, ì´ë¯¸ ê´œì°®ì•„.", "It will be okay. No, it already is."],
    ["ê¸°ë‹¤ë¦¼ë„ ì›€ì§ì„ì´ì•¼.", "Waiting is also moving."],
    ["ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ì œë³´ë‹¤ ë‹¤ì •í•´.", "Today I'm kinder than yesterday."],
    ["ë‚˜ë¥¼ ë¯¿ëŠ” ë°©ë²•ì„ ë°°ìš°ëŠ” ì¤‘.", "Learning to trust myself."],
    ["í”ë“¤ë ¤ë„ ë¶€ëŸ¬ì§€ì§€ ì•Šì•„.", "I bend, but I don't break."],
    ["ë°¤ì´ ê¹Šì„ìˆ˜ë¡ ë³„ì€ ì„ ëª…í•´.", "The darker the night, the clearer the stars."],
    ["ê´œì°®ì•„, í•¨ê»˜ ê°€ë©´ ë¼.", "It's okay; we'll go together."],
    ["ë„ˆì˜ ì´ì•¼ê¸°ëŠ” ê³„ì†ë˜ê³  ìˆì–´.", "Your story is still unfolding."],
    ["ì‚¬ë‘ì€ ì²œì²œíˆ ìŠ¤ë©°ë“¤ì–´.", "Love seeps in slowly."],
    ["ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ì•ˆì•„ì¤˜.", "Hug the you of today."],
    ["ê°ì‚¬ì—ì„œ ì‹œì‘í•´ ë´.", "Start with gratitude."],
    ["ë‹¤ìŒ í˜ì´ì§€ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´.", "The next page is waiting."]
  ];

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function save(){
    const data = {
      main: els.main.value,
      sub: els.sub.value,
      to: els.to.value,
      base: els.base.value,
      utm_source: els.utm_source.value,
      utm_medium: els.utm_medium.value,
      utm_campaign: els.utm_campaign.value,
      quietZone: +els.quietZone.value || 16,
      fontFamily: els.fontFamily.value,
      fontWeight: els.fontWeight.value,
      tracking: els.tracking.value,
      leading: els.leading.value,
      showRoman: els.showRoman.value,
      theme: els.theme.value,
      voice: els.voice.value,
      rate: els.rate.value,
      pitch: els.pitch.value,
      fontCredit: els.fontCredit.value,
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      for(const k in d){
        const el = els[k] || null;
        if(el){
          if(el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA"){
            el.value = d[k];
          }
        }
      }
    }catch(e){ console.warn(e); }
  }

  function updateView(){
    els.vMain.textContent = els.main.value || "ê´œì°®ì•„. ì˜¤ëŠ˜ì˜ ë„ˆë„ ì¶©ë¶„íˆ ë©‹ì ¸.";
    els.vSub.textContent  = els.sub.value || "It's okay. You're doing enough today.";
    els.vTo.textContent   = els.to.value ? `To. ${els.to.value}` : " ";
    els.vCredit.textContent = els.fontCredit.value ? `Font: ${els.fontCredit.value}` : " ";
    // typography
    els.msgWrap.style.fontFamily   = els.fontFamily.value;
    els.msgWrap.style.letterSpacing= `${els.tracking.value}px`;
    els.msgWrap.style.lineHeight   = els.leading.value;
    els.vMain.style.fontWeight     = els.fontWeight.value;
    els.wVal.textContent           = els.fontWeight.value;
    els.vSub.style.display         = (els.showRoman.value === "on") ? "block" : "none";

    // theme
    if(els.theme.value === "warm") els.card.style.background = "var(--gradient-warm)";
    if(els.theme.value === "cool") els.card.style.background = "var(--gradient-cool)";
    if(els.theme.value === "wood") els.card.style.background = "var(--gradient-wood)";

    // update URL view (does not regenerate)
    const url = buildLink(false);
    els.vUrl.textContent = url || "â€”";
    els.aPreview.href = url || "#";
    save();
  }

  function koreanRomanizeSimple(kor){
    // VERY SIMPLE romanization (not official). User can edit.
    // Map initials (approx) â€“ works best for common words
    const mapChoseong = {
      "ã„±":"g","ã„²":"kk","ã„´":"n","ã„·":"d","ã„¸":"tt","ã„¹":"r","ã…":"m","ã…‚":"b","ã…ƒ":"pp","ã……":"s","ã…†":"ss","ã…‡":"","ã…ˆ":"j","ã…‰":"jj","ã…Š":"ch","ã…‹":"k","ã…Œ":"t","ã…":"p","ã…":"h"
    };
    const mapJung = {
      "ã…":"a","ã…":"ae","ã…‘":"ya","ã…’":"yae","ã…“":"eo","ã…”":"e","ã…•":"yeo","ã…–":"ye","ã…—":"o","ã…˜":"wa","ã…™":"wae","ã…š":"oe","ã…›":"yo","ã…œ":"u","ã…":"wo","ã…":"we","ã…Ÿ":"wi","ã… ":"yu","ã…¡":"eu","ã…¢":"ui","ã…£":"i"
    };
    const mapJong = {
      "":"", "ã„±":"k","ã„²":"k","ã„³":"k","ã„´":"n","ã„µ":"n","ã„¶":"n","ã„·":"t","ã„¹":"l","ã„º":"k","ã„»":"m","ã„¼":"p","ã„½":"l","ã„¾":"l","ã„¿":"p","ã…€":"l","ã…":"m","ã…‚":"p","ã…„":"p","ã……":"t","ã…†":"t","ã…‡":"ng","ã…ˆ":"t","ã…Š":"t","ã…‹":"k","ã…Œ":"t","ã…":"p","ã…":"t"
    };
    // Use Hangul decomposition via Unicode arithmetic
    const BASE = 0xac00, CHO = 588, JUNG = 28;
    const CHO_LIST = "ã„±ã„²ã„´ã„·ã„¸ã„¹ã…ã…‚ã…ƒã……ã…†ã…‡ã…ˆã…‰ã…Šã…‹ã…Œã…ã…".split("");
    const JUNG_LIST= "ã…ã…ã…‘ã…’ã…“ã…”ã…•ã…–ã…—ã…˜ã…™ã…šã…›ã…œã…ã…ã…Ÿã… ã…¡ã…¢ã…£".split("");
    const JONG_LIST= ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

    let out = "";
    for(const ch of kor){
      const code = ch.charCodeAt(0) - BASE;
      if(code >= 0 && code < 11172){
        const cho = CHO_LIST[Math.floor(code / CHO)];
        const jung= JUNG_LIST[Math.floor((code % CHO)/JUNG)];
        const jong= JONG_LIST[code % JUNG];
        out += (mapChoseong[cho] || "") + (mapJung[jung] || "") + (mapJong[jong] || "");
      }else{
        out += ch; // punctuation/space
      }
    }
    // tidy
    out = out.replace(/\s+/g," ").trim();
    out = out.replace(/\bgeonchang\b/gi, "geonchan"); // tiny tweak
    return out;
  }

  // Build link with query-params
  function buildLink(updateViewHref=true){
    const base = (els.base.value||"").trim();
    if(!base) return "";
    const url = new URL(base);
    const params = new URLSearchParams(url.search);
    if(els.main.value) params.set("m", els.main.value);
    if(els.sub.value)  params.set("r", els.sub.value);
    if(els.to.value)   params.set("to", els.to.value);
    if(els.utm_source.value)   params.set("utm_source", els.utm_source.value);
    if(els.utm_medium.value)   params.set("utm_medium", els.utm_medium.value);
    if(els.utm_campaign.value) params.set("utm_campaign", els.utm_campaign.value);
    url.search = params.toString();
    const s = url.toString();
    if(updateViewHref){
      els.aPreview.href = s;
      els.vUrl.textContent = s;
    }
    return s;
  }

  function copyText(t){
    navigator.clipboard.writeText(t).then(()=>{
      toast("ë³µì‚¬ ì™„ë£Œ!");
    }).catch(()=>{
      alert("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
    });
  }

  function toast(msg){
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", left:"50%", transform:"translateX(-50%)",
      bottom:"24px", background:"#2a241e", color:"#ffd1a6", border:"1px solid #3a3128",
      padding:"10px 14px", borderRadius:"12px", zIndex:9999, boxShadow:"0 10px 20px rgba(0,0,0,.35)"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1400);
  }

  // Deterministic "today's message"
  function todayPick(){
    const today = new Date();
    const seed = Number(`${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,"0")}${today.getDate().toString().padStart(2,"0")}`);
    const idx = seed % MESSAGES.length;
    els.main.value = MESSAGES[idx][0];
    els.sub.value  = MESSAGES[idx][1];
    updateView();
  }

  function randomPick(){
    const idx = Math.floor(Math.random() * MESSAGES.length);
    els.main.value = MESSAGES[idx][0];
    els.sub.value  = MESSAGES[idx][1];
    updateView();
  }

  // QR
  let qrInstance = null;
  function makeQR(){
    const target = buildLink(true) || els.base.value;
    if(!target){
      alert("ë¨¼ì € ë§í¬ë¥¼ ì…ë ¥/ìƒì„±í•´ì£¼ì„¸ìš”.");
      return;
    }
    // clear
    els.qr.innerHTML = "";
    // quiet zone by padding container
    const qz = clamp(parseInt(els.quietZone.value || "16",10), 0, 64);
    els.qrBox.style.padding = `${qz}px`;

    qrInstance = new QRCode(els.qr, {
      text: target,
      width: 160,
      height: 160,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });
    toast("QR ìƒì„± ì™„ë£Œ");
  }

  // html-to-image export
  async function downloadPNG(){
    const node = els.card;
    // temporarily hide the big play button to keep QR clear? keep it visible by default.
    try{
      const dataUrl = await htmlToImage.toPng(node, {pixelRatio: 2});
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "healing_card.png";
      a.click();
    }catch(e){
      console.error(e);
      alert("PNG ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // TTS
  let voices = [];
  function loadVoices(){
    voices = speechSynthesis.getVoices();
    els.voice.innerHTML = "";
    // prefer ko-KR
    const sorted = [...voices].sort((a,b)=>{
      const aK = a.lang.includes("ko") ? 0 : 1;
      const bK = b.lang.includes("ko") ? 0 : 1;
      if(aK !== bK) return aK - bK;
      return a.name.localeCompare(b.name);
    });
    for(const v of sorted){
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      els.voice.appendChild(opt);
    }
    // select first ko voice
    const ko = sorted.find(v=>v.lang.startsWith("ko"));
    if(ko) els.voice.value = ko.name;
  }
  window.speechSynthesis.onvoiceschanged = loadVoices;

  function speak(text){
    if(!window.speechSynthesis){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const sel = voices.find(v=>v.name === els.voice.value) || voices.find(v=>v.lang.startsWith("ko")) || voices[0];
    if(sel) u.voice = sel;
    u.lang = sel?.lang || "ko-KR";
    u.rate = parseFloat(els.rate.value);
    u.pitch= parseFloat(els.pitch.value);
    speechSynthesis.speak(u);
  }

  // Presets
  function savePreset(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ toast("ë¨¼ì € ê°’ì„ ì±„ì›Œì£¼ì„¸ìš”."); return; }
    const presets = JSON.parse(localStorage.getItem(STORAGE_KEY + ":presets") || "[]");
    presets.unshift({ at: Date.now(), data: JSON.parse(raw) });
    localStorage.setItem(STORAGE_KEY + ":presets", JSON.stringify(presets.slice(0, 20)));
    toast("í˜„ì¬ê°’ì„ ì €ì¥í–ˆì–´ìš”.");
  }

  // ---------- Event bindings ----------
  ["input","change"].forEach(ev => {
    [els.main, els.sub, els.to, els.base, els.utm_source, els.utm_medium, els.utm_campaign,
     els.quietZone, els.fontFamily, els.fontWeight, els.tracking, els.leading, els.showRoman, els.theme,
     els.voice, els.rate, els.pitch, els.fontCredit
    ].forEach(el => el.addEventListener(ev, updateView));
  });

  els.romanBtn.addEventListener("click", ()=>{
    if(!els.main.value){ alert("ë¨¼ì € í•œê¸€ ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
    els.sub.value = koreanRomanizeSimple(els.main.value);
    updateView();
  });
  els.randomBtn.addEventListener("click", randomPick);
  els.todayBtn.addEventListener("click", todayPick);
  els.buildLink.addEventListener("click", ()=>{ buildLink(true); toast("ë§í¬ë¥¼ ìƒì„±í–ˆì–´ìš”."); });
  els.copyLink.addEventListener("click", ()=>{ const s = buildLink(true); if(s) copyText(s); });
  els.copyLinkTop.addEventListener("click", ()=>{ const s = buildLink(true); if(s) copyText(s); });
  els.openLink.addEventListener("click", ()=>{ const s = buildLink(true); if(s) window.open(s, "_blank"); });
  els.makeQR.addEventListener("click", makeQR);
  els.downloadPNG.addEventListener("click", downloadPNG);
  els.copyAll.addEventListener("click", ()=>{
    const payload = {
      message_kr: els.main.value,
      message_roman: els.sub.value,
      to: els.to.value,
      link: buildLink(true),
      utm: {source: els.utm_source.value, medium: els.utm_medium.value, campaign: els.utm_campaign.value},
      font: { family: els.fontFamily.value, weight: els.fontWeight.value, tracking: els.tracking.value, leading: els.leading.value },
      theme: els.theme.value,
      fontCredit: els.fontCredit.value,
    };
    copyText(JSON.stringify(payload, null, 2));
  });
  els.play.addEventListener("click", ()=>{ speak( els.main.value || els.vMain.textContent ); });
  els.previewTTS.addEventListener("click", ()=>{ speak( els.main.value || els.vMain.textContent ); });

  els.reset.addEventListener("click", ()=>{
    if(confirm("ëª¨ë“  ê°’ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });
  els.help.addEventListener("click", ()=>{
    alert([
      "â€¢ ë©”ì„¸ì§€(í•œê¸€)ë¥¼ ì…ë ¥í•˜ê³  â€˜ê°„ì´ ë¡œë§ˆì ìë™â€™ì„ ëˆŒëŸ¬ ì˜ë¬¸/ë¡œë§ˆìë¥¼ ì±„ìš¸ ìˆ˜ ìˆì–´ìš”.",
      "â€¢ â€˜ë§í¬ ìƒì„±â€™ì„ ëˆ„ë¥´ë©´ ?m, ?r, ?to ì¿¼ë¦¬ë¡œ ëœë”©í˜ì´ì§€ì— ì „ë‹¬ë©ë‹ˆë‹¤.",
      "â€¢ â€˜QR ìƒì„±/ì—…ë°ì´íŠ¸â€™ë¡œ ì¦‰ì‹œ QRì„ ë§Œë“¤ê³ , PNG ë‚´ë³´ë‚´ê¸°ë¡œ ì¹´ë“œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ì„¸ìš”.",
      "â€¢ â€˜ì˜¤ëŠ˜ì˜ ë¬¸ì¥â€™ì€ ë‚ ì§œ ê¸°ë°˜ ê³ ì • ì„ íƒ, â€˜ëœë¤â€™ì€ ë¬´ì‘ìœ„ ì„ íƒì…ë‹ˆë‹¤.",
      "â€¢ í°íŠ¸ ì¶œì²˜(Font Credit)ëŠ” ì¹´ë“œ í•˜ë‹¨ì— í‘œê¸°ë©ë‹ˆë‹¤.",
      "â€¢ ì…ë ¥ê°’ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤."
    ].join("\n"));
  });
  els.savePreset.addEventListener("click", savePreset);

  // ---------- Init ----------
  load();
  updateView();
  // default QR if base url exists
  setTimeout(()=>{ if(els.base.value) makeQR(); }, 700);
  // load voices after a tiny delay (some browsers need a kick)
  setTimeout(loadVoices, 300);
  </script>
</body>
</html>
