<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>힐링메세지 메이커 v1.1 — Inspire Wood</title>
<meta name="theme-color" content="#111111">
<style>
  :root{ --maxw: 980px; --radius: 16px; --shadow: 0 12px 36px rgba(0,0,0,.08); --muted:#666; }
  *{ box-sizing: border-box }
  html,body{ margin:0; padding:0 }
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
    background:
      radial-gradient(1100px 700px at 10% -10%, rgba(255,232,210,.85), transparent 60%),
      radial-gradient(900px 600px at 95% 110%, rgba(255,214,214,.7), transparent 55%),
      linear-gradient(180deg, #fff7f0 0%, #fde7d8 100%);
    color:#111; line-height:1.55;
  }
  .wrap{ padding: clamp(16px, 4vw, 40px); display:flex; justify-content:center }
  .container{ width:100%; max-width: var(--maxw); display:grid; gap: 16px }
  header{ display:flex; align-items:baseline; gap: 12px; flex-wrap:wrap }
  h1{ margin:0; font-size: clamp(22px, 3.6vw, 32px) }
  .sub{ color: var(--muted); font-size: 13px }
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
         border:1px solid #e5e7eb; background:#fff; text-decoration:none; color:#111; font-weight:600; font-size:13px; }
  .chip:hover{ border-color:#d1d5db }
  .grid{ display:grid; gap:16px }
  .card{ background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: clamp(16px, 2.8vw, 28px); }
  label{ font-size: 14px; font-weight:600; display:block; margin-bottom: 6px }
  input[type="text"], input[type="url"], input[readonly], textarea, select{
    width:100%; padding:12px 12px; border-radius: 12px; border:1px solid #ddd; font-size:16px;
  }
  input[readonly]{ background:#fafafa; color:#555 }
  textarea{ resize: vertical; min-height: 84px }
  .rows{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
  .btn{ padding:10px 14px; border-radius: 12px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:14px }
  .btn.primary{ background:#111; color:#fff; border-color:#111 }
  .btn.ghost{ background:#f7f7f7 }
  .small{ font-size:12px; color:#777 }
  .out{ background:#fff; border-radius: 12px; border:1px dashed #ddd; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all; }
  .divider{ height:1px; background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,0)); margin: 12px 0 }
  .list{ display:grid; gap:8px; max-height:300px; overflow:auto; padding-right:4px }
  .item{ display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; }
  .item input[type="text"]{ padding:10px 10px; font-size:14px }
  .muted{ color:#6b7280; font-size:12px }
  .hl{ background:#fff6d5; padding:2px 6px; border-radius:6px }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px }
</style>
</head>
<body>
  <div class="wrap">
    <div class="container">

      <div class="topbar">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <a class="chip" href="./card/" target="_blank">미리보기: 카드</a>
          <a class="chip" href="../">← Healing (Landing)</a>
          <a class="chip" href="../tools/">Tools Dashboard</a>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="chip" id="exportData">Export JSON</button>
          <label class="chip" style="cursor:pointer">Import JSON<input type="file" id="importData" accept="application/json" style="display:none"></label>
          <button class="chip" id="resetAll">Reset</button>
        </div>
      </div>

      <header>
        <h1>힐링메세지 메이커 <span class="hl">v1.1</span></h1>
        <div class="sub">주문자 이름 · 카테고리 · 문장 목록을 관리하고 <b>카드 URL / 단축TXT</b>를 만듭니다. 카드 페이지는 <span class="kbd">/healing/card/</span> 입니다.</div>
      </header>

      <section class="card grid">
        <div class="rows">
          <div>
            <label for="name">주문자 이름</label>
            <input type="text" id="name" placeholder="예: 김민지 / Olivia / Team IW">
          </div>
          <div>
            <label for="cardBase">Card Base URL</label>
            <div class="row">
              <input type="url" id="cardBase" value="https://inspire-wood.github.io/its-okay/healing/card/">
              <button class="btn" id="detectBase">현재 경로</button>
            </div>
            <div class="small">보통 수정할 필요 없음</div>
          </div>
        </div>

        <div class="rows">
          <div>
            <label for="cat">메세지 항목 선택</label>
            <div class="row">
              <select id="cat" aria-label="카테고리 선택"></select>
              <button class="btn" id="addCat">항목 추가</button>
            </div>
            <div class="small">기본: 힐링메세지 · 성경구절 · 기타</div>
          </div>
          <div>
            <label>표시 방식</label>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
              <label><input type="radio" name="mode" value="daily" checked> 매일 랜덤</label>
              <label><input type="radio" name="mode" value="fixed"> 선택 고정</label>
            </div>
            <div class="small">고정인 경우, 아래 목록에서 선택된 문장이 카드에 표시됩니다.</div>
          </div>
        </div>

        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <h3 style="margin:0">선택한 항목의 메세지 목록</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="addMsg">문장 추가</button>
              <button class="btn ghost" id="saveList">저장</button>
              <span class="small">라디오 선택된 문장이 <b>고정</b> 모드에서 사용됩니다.</span>
            </div>
          </div>
          <div class="list" id="msgList" aria-label="메세지 목록"></div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div>
            <h3 style="margin:0 0 8px">데이타(JSON) 만들기</h3>
            <div class="rows">
              <div>
                <label for="slug">슬러그(slug)</label>
                <div class="row">
                  <input type="text" id="slug" placeholder="예: mj-healing / grace-001">
                  <button class="btn" id="autoslug">자동 생성</button>
                </div>
                <div class="small">업로드 경로 예시: <code>/its-okay/data/<b>[slug]</b>.json</code></div>
              </div>
              <div>
                <label>다운로드</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <a class="btn" id="downloadData" download="data.json">데이타 JSON</a>
                  <a class="btn ghost" id="downloadRedirect" download="slug.html">리디렉트 HTML(옵션)</a>
                </div>
                <div class="small">JSON을 <code>data/[slug].json</code>으로 업로드 → 카드에서 불러옵니다.</div>
              </div>
            </div>
          </div>

          <div>
            <h3 style="margin:0 0 8px">카드 URL 생성 / 복사 / 새창</h3>
            <div class="rows">
              <div>
                <label for="preview">선택된 문장 미리보기</label>
                <textarea id="preview" readonly placeholder="문장을 선택하세요"></textarea>
              </div>
              <div>
                <label>동작</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn primary" id="build">URL 생성</button>
                  <button class="btn" id="copy">URL 복사</button>
                  <a class="btn" id="open" target="_blank" rel="noopener">새 창에서 열기</a>
                </div>
                <div style="height:10px"></div>
                <div class="out" id="out">여기에 결과 URL이 표시됩니다</div>
                <div class="small">형식: <code>[cardBase]?name=...&mode=daily|fixed&cat=...&sel=0&data=https://.../data/[slug].json</code></div>
              </div>
            </div>
          </div>
        </div>

      </section>

      <p class="muted">© Inspire Wood — Healing Message Maker v1.1</p>
    </div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const key = 'healingMakerV11';

  function load(){ try{ return JSON.parse(localStorage.getItem(key)||'{}'); }catch(e){ return {}; } }
  function save(st){ localStorage.setItem(key, JSON.stringify(st)); }

  function defaultState(){
    return {
      name:'',
      cardBase:'https://inspire-wood.github.io/its-okay/healing/card/',
      cats:['힐링메세지','성경구절','기타'],
      msgs:{
        '힐링메세지':['오늘의 햇살처럼 마음도 밝아지길'],
        '성경구절':['주는 그리스도 시요 살아계신 하나님의 아들이시니이다. 마16:16'],
        '기타':[]
      },
      currentCat:'힐링메세지',
      selected:{'힐링메세지':0},
      mode:'daily',
      slug:''
    };
  }

  let st = Object.assign(defaultState(), load());
  init();

  function init(){
    $('#name').value = st.name||'';
    $('#cardBase').value = st.cardBase||defaultState().cardBase;
    $('#slug').value = st.slug||'';

    renderCats(); $('#cat').value = st.currentCat; renderList();
    $$('input[name="mode"]').forEach(r=>{ r.checked = (r.value===st.mode); r.addEventListener('change',()=>{ st.mode=r.value; save(st); buildUrl(); }); });

    $('#name').addEventListener('input', ()=>{ st.name=$('#name').value; save(st); syncDownloads(); });
    $('#cardBase').addEventListener('input', ()=>{ st.cardBase=$('#cardBase').value; save(st); buildUrl(); });
    $('#cat').addEventListener('change', ()=>{ st.currentCat=$('#cat').value; save(st); renderList(); buildUrl(); });
    $('#addCat').addEventListener('click', showAddCat);
    $('#addMsg').addEventListener('click', ()=> addMsg(''));
    $('#saveList').addEventListener('click', ()=>{ save(st); alert('저장됨'); });

    $('#autoslug').addEventListener('click', ()=>{ $('#slug').value = slugifyCandidate(); st.slug=$('#slug').value; save(st); syncDownloads(); buildUrl(); });
    $('#slug').addEventListener('input', ()=>{ st.slug=$('#slug').value; save(st); syncDownloads(); buildUrl(); });

    $('#exportData').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(st,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='healing-maker-export.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });
    $('#importData').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      try{ const obj = JSON.parse(await f.text()); st = Object.assign(defaultState(), obj); save(st); init(); alert('가져오기 완료'); }
      catch(e){ alert('JSON 파싱 실패: '+e.message); }
    });
    $('#resetAll').addEventListener('click', ()=>{ if(!confirm('모든 값을 초기화할까요?')) return; localStorage.removeItem(key); st=defaultState(); init(); });

    $('#build').addEventListener('click', buildUrl);
    $('#copy').addEventListener('click', async ()=>{ const url = buildUrl(); try{ await navigator.clipboard.writeText(url); alert('복사됨'); }catch(e){ prompt('복사 실패 — 수동 복사', url); } });
    $('#open').addEventListener('click', buildUrl);

    $('#downloadData').addEventListener('click', ()=>{
      const data = { name: st.name, cats: st.cats, msgs: st.msgs };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = $('#downloadData'); const slug = ($('#slug').value||'data').trim()||'data';
      a.href = URL.createObjectURL(blob);
      a.download = slug + '.json';
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    });

    $('#downloadRedirect').addEventListener('click', ()=>{
      const url = buildUrl();
      const html = '<!doctype html><meta charset="utf-8">'+
                   '<meta http-equiv="refresh" content="0;url='+url.replace(/\"/g,'&quot;')+'">'+
                   '<link rel="canonical" href="'+url.replace(/\"/g,'&quot;')+'">'+
                   '<title>Redirecting...</title>'+
                   '<p>Redirecting to <a href="'+url.replace(/\"/g,'&quot;')+'">target</a>...</p>';
      const blob = new Blob([html], {type:'text/html'});
      const a2 = $('#downloadRedirect'); const slug = ($('#slug').value||'go').trim()||'go';
      a2.href = URL.createObjectURL(blob); a2.download = slug + '.html';
      setTimeout(()=>URL.revokeObjectURL(a2.href), 1000);
    });

    $('#detectBase').addEventListener('click', ()=>{
      try{
        const {origin, pathname} = location;
        const ix = pathname.indexOf('/its-okay/');
        const base = ix>=0 ? (origin + pathname.slice(0, ix+10) + 'healing/card/') : 'https://inspire-wood.github.io/its-okay/healing/card/';
        $('#cardBase').value = base; st.cardBase = base; save(st);
      }catch(e){}
    });

    syncDownloads();
    buildUrl();
  }

  function renderCats(){
    const el = $('#cat'); el.innerHTML = '';
    st.cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; el.appendChild(o); });
  }
  function showAddCat(){
    const name = prompt('새 항목 이름');
    if(!name) return;
    if(st.cats.includes(name)) return alert('이미 존재합니다');
    st.cats.push(name); st.msgs[name]=[]; st.selected[name]=0; st.currentCat=name; save(st);
    renderCats(); $('#cat').value=name; renderList();
  }
  function renderList(){
    const wrap = $('#msgList'); wrap.innerHTML='';
    const cat = st.currentCat, list = st.msgs[cat]||[];
    list.forEach((txt, idx)=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `
        <input type="radio" name="pick" ${(st.selected[cat]||0)===idx?'checked':''} aria-label="선택">
        <input type="text" value="${escapeHtml(txt)}" aria-label="문장">
        <button class="btn" title="삭제">삭제</button>`;
      const r=row.querySelector('input[type="radio"]');
      const t=row.querySelector('input[type="text"]');
      const d=row.querySelector('button');
      r.addEventListener('change', ()=>{ st.selected[cat]=idx; save(st); updatePreview(); buildUrl(); });
      t.addEventListener('input', ()=>{ list[idx]=t.value; save(st); updatePreview(); });
      d.addEventListener('click', ()=>{ if(confirm('삭제할까요?')){ list.splice(idx,1); if((st.selected[cat]||0)>=list.length) st.selected[cat]=0; save(st); renderList(); } });
      wrap.appendChild(row);
    });
    updatePreview();
  }
  function addMsg(txt){ const cat=st.currentCat; st.msgs[cat]=st.msgs[cat]||[]; st.msgs[cat].push(txt||''); st.selected[cat]=st.msgs[cat].length-1; save(st); renderList(); }
  function currentMessage(){ const cat=st.currentCat, list=st.msgs[cat]||[]; const ix=Math.max(0,Math.min(st.selected[cat]||0,(list.length-1))); return list[ix]||''; }
  function updatePreview(){ $('#preview').value = currentMessage(); }

  function slugifyCandidate(){
    const name = ($('#name').value||'').trim().toLowerCase();
    let s = name.replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    if(!s){ const n = name||st.currentCat||'h'; s = 'h-'+ (n.charCodeAt(0)||104).toString(36); }
    return s;
  }
  function syncDownloads(){
    const slug = ($('#slug').value||'').trim() || slugifyCandidate();
    const dataUrl = 'https://inspire-wood.github.io/its-okay/data/' + slug + '.json';
    $('#downloadData').textContent = '데이타 JSON ('+slug+'.json)';
    $('#downloadRedirect').textContent = '리디렉트 HTML ('+slug+'.html)';
    $('#preview').placeholder = '문장을 선택하세요';
    return dataUrl;
  }

  function buildUrl(){
    const base = ($('#cardBase').value||'').trim()||'https://inspire-wood.github.io/its-okay/healing/card/';
    const name = ($('#name').value||'').trim();
    const cat = st.currentCat;
    const msg = currentMessage();
    const mode = (Array.from(document.querySelectorAll('input[name="mode"]')).find(r=>r.checked)||{value:'daily'}).value;
    const slug = ($('#slug').value||'').trim() || slugifyCandidate();
    const dataUrl = 'https://inspire-wood.github.io/its-okay/data/' + slug + '.json';

    const params = new URLSearchParams();
    if(name) params.set('name', name);
    params.set('mode', mode); // daily | fixed
    if(cat) params.set('cat', cat);
    if(mode==='fixed'){ const ix = st.selected[cat]||0; params.set('sel', String(ix)); }
    params.set('data', dataUrl);

    const url = base.replace(/\/+$/,'/') + (params.toString()?('?'+params.toString()):'');
    $('#out').textContent = url;
    $('#open').href = url;

    // Also refresh download links to include current long URL
    const html = '<!doctype html><meta charset="utf-8">'+
                 '<meta http-equiv="refresh" content="0;url='+url.replace(/\"/g,'&quot;')+'">'+
                 '<link rel="canonical" href="'+url.replace(/\"/g,'&quot;')+'">'+
                 '<title>Redirecting...</title>'+
                 '<p>Redirecting to <a href="'+url.replace(/\"/g,'&quot;')+'">target</a>...</p>';
    const b2 = new Blob([html], {type:'text/html'});
    const a2 = $('#downloadRedirect'); a2.href = URL.createObjectURL(b2);

    // Data JSON blob
    const data = { name: st.name, cats: st.cats, msgs: st.msgs };
    const b1 = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a1 = $('#downloadData'); a1.href = URL.createObjectURL(b1);

    return url;
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s])); }
</script>
</body>
</html>
